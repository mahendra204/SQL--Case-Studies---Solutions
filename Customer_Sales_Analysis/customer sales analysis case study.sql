use casestudy
CREATE TABLE customers (
customer_id INT PRIMARY KEY,
first_shop DATE,
age INT,
rewards VARCHAR(50),
can_email VARCHAR(50)
);
INSERT INTO customers 
VALUES (1, '2022-03-20', 23, 'yes', 'no'),(2, '2022-03-25', 26, 'no', 'no'),
(3, '2022-04-06', 32, 'no', 'no'),(4, '2022-04-13', 25, 'yes', 'yes'),
(5, '2022-04-22', 49, 'yes', 'yes'),(6, '2022-06-18', 28, 'yes', 'no'),
(7, '2022-06-30', 36, 'no', 'no'),(8, '2022-07-04', 37, 'yes', 'yes');

CREATE TABLE orders (order_id INT PRIMARY KEY,
customer_id INT,date_shop DATE,
sales_channel VARCHAR(50),country_id INT,
FOREIGN KEY (customer_id) REFERENCES customers(customer_id),
FOREIGN KEY (country_id) REFERENCES country(country_id)
);

INSERT INTO orders 
VALUES (1, 1, '2023-01-16', 'retail', 1),(2, 4, '2023-01-20', 'retail', 1),
(3, 2, '2023-01-25', 'retail', 2),(4, 3, '2023-01-25', 'online', 1),
(5, 1, '2023-01-28', 'retail', 3),(6, 5, '2023-02-02', 'online', 1),
(7, 6, '2023-02-05', 'retail', 1),(8, 3, '2023-02-11', 'online', 3);

CREATE TABLE country (country_id INT PRIMARY KEY,
country_name VARCHAR(50),head_office VARCHAR(50)
);
INSERT INTO country
VALUES (1, 'UK', 'London'),(2, 'USA', 'New York'),(3, 'China', 'Beijing');

CREATE TABLE products (
product_id INT PRIMARY KEY,category VARCHAR(50),price NUMERIC(5,2)
);
INSERT INTO products 
VALUES (1, 'food', 5.99),(2, 'sports', 12.49),(3, 'vitamins', 6.99),
(4, 'food', 0.89),(5, 'vitamins', 15.99);


--Q1. What are the names of all the countries in the country table? and find how many of them are head_office locatd in New yourk?
select country_name from country
select count(country_name) from country        -- no.of countries in country table
select count(distinct country_name) from country   ---no.of unique countries in country table
select count(distinct country_name) from country where head_office in
 (select head_office from country where head_office='New York')  -- no.of unique countries and those head_offices are located in newyork.
--or 
with cte as (select head_office, count(country_name) as no_of_countries from country group by head_office)
select no_of_countries from cte where head_office='New York'      -- no.of unique countries and those head_offices are located in newyork.

--Q2. What is the average age of customers who can receive marketing emails (can_email is set to 'yes')?
select average_age from (select avg(age) as average_age, can_email from 
customers group by can_email)a where can_email='Yes'


--Q3. How many orders were made by each customer in each sales channel (sales_channel column) in the orders table?
select * from orders
select customer_id, count(sales_channel) as no_of_channels from orders group by customer_id


--Q4. How many orders were made by customers aged 30 or older who gor rewards?
select count(*) from customers where age>=30 and rewards='Yes'

--Q5. What is the total revenue generated by each product category?
select category, revenue, rank() over(order by revenue desc) as highest_revenue_ranks from(
select category, sum(price) as revenue from products group by category) a

--Q6. What is the average price of products in the 'food' category?
select average_price from(
select category,round(avg(price),2) average_price from products group by category)a 
where a.category='food' 

--Q7.What is the date of the latest order made by a customer who can receive marketing emails?
with cte as(select top 1 o.date_shop as latest_order, c.can_email from orders o join customers c 
on o.customer_id=c.customer_id where can_email='yes' order by date_shop desc)
select latest_order from cte

--Q8. What is the name and no.of orders in the country with the highest number of orders?
with cte as(select o.order_id, c.country_name from orders o join country c on c.country_id=o.country_id)
select top 1 count(order_id) as highest_no_of_orders, country_name from 
cte group by country_name order by highest_no_of_orders desc

select * from customers
select * from orders
select * from products
select * from country
